<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Show PRO Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #6C63FF;
            --accent: #42EADD;
            --bg: #1a1a2e;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-strong: rgba(20, 20, 35, 0.98);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --red-btn: #ff4757;
            --green-btn: #2ed573;
            --gold: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* --- LAYOUTS --- */
        .screen { display: none; flex-direction: column; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: var(--bg); z-index: 2; }
        .screen.active { display: flex; }

        /* --- HEADER JUIZ --- */
        .judge-header {
            padding: 10px 15px; background: rgba(0,0,0,0.6); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border);
        }
        .switch-container { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        
        /* Switch CSS */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- SCOREBOARD --- */
        .scoreboard {
            display: flex; justify-content: space-around; padding: 10px;
            background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border);
            font-weight: bold; font-size: 1.5rem; transition: all 0.3s;
        }
        .score-box { display: flex; gap: 10px; align-items: center; }
        .sc-red { color: var(--red-btn); }
        .sc-green { color: var(--green-btn); }

        /* --- LOBBY --- */
        .lobby-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .lobby-box { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 20px; padding: 2rem; width: 100%; max-width: 400px; text-align: center; backdrop-filter: blur(10px); }
        input[type="text"] { width: 100%; padding: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 10px; color: white; text-align: center; }
        .role-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; }
        .btn-judge { background: var(--primary); }
        .btn-red { background: var(--red-btn); }
        .btn-green { background: var(--green-btn); }

        /* --- JUIZ CONTENT --- */
        .judge-content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .buzzer-status { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; text-align: center; font-weight: bold; font-size: 1.1rem; border: 2px solid transparent; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .timer-display { font-size: 2.5rem; text-align: center; font-weight: bold; color: var(--gold); height: 50px; }
        
        .question-card { background: var(--glass-strong); border: 1px solid var(--glass-border); border-radius: 10px; padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .q-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 10px; text-transform: uppercase; }
        .q-text { font-size: 1.1rem; margin-bottom: 15px; line-height: 1.4; flex-grow: 1; }
        .answer-option { background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.9rem; display: flex; justify-content: space-between; }
        .answer-option.correct { border: 1px solid var(--green-btn); color: var(--green-btn); font-weight: bold; }
        .answer-option.selected { background: rgba(255,255,255,0.3); border-left: 4px solid var(--accent); }

        /* --- CONTROLS AREA --- */
        .controls-area { padding: 10px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--glass-border); }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .btn-grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .action-btn { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 0.8rem; cursor: pointer; transition: opacity 0.3s; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-easy { background: #2ed573; color: #000; }
        .btn-med { background: #ffa502; color: #000; }
        .btn-hard { background: #ff4757; color: #fff; }
        .btn-rand { background: #747d8c; }

        /* --- PLAYER SCREEN --- */
        .player-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .big-button { width: 220px; height: 220px; border-radius: 50%; border: 8px solid rgba(255,255,255,0.3); font-size: 1.5rem; font-weight: 900; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 5; }
        .big-button:active { transform: scale(0.95); }
        .btn-bg-red { background: var(--red-btn); }
        .btn-bg-green { background: var(--green-btn); }
        .big-button.locked { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        
        /* Animações */
        .celebrating { animation: pulseWin 0.8s infinite alternate; border-color: var(--gold); box-shadow: 0 0 50px var(--gold); }
        @keyframes pulseWin { from { transform: scale(1); } to { transform: scale(1.05); } }

        .sad-shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-10px); } 100% { transform: translateX(0); } }

        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 10; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* Modal Player */
        .player-q-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--glass-strong); z-index: 20; display: none; flex-direction: column; padding: 20px; }
        .p-opt-btn { width: 100%; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; text-align: left; font-size: 1rem; }
        .p-opt-btn.selected { background: var(--primary); border-color: var(--accent); }

        /* Loading */
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99; display: none; place-items: center; color: white; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div><span id="loadMsg">Conectando...</span></div>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="lobby-box">
                <h1>QUIZ PRO <i class="fa-solid fa-brain"></i></h1>
                <input type="text" id="roomName" placeholder="Nome da Sala (Ex: familia)" autocomplete="off">
                <input type="text" id="playerName" placeholder="Seu Nome" autocomplete="off">
                <br><br>
                <button class="role-btn btn-judge" onclick="joinGame('judge')"><i class="fa-solid fa-gavel"></i> JUIZ (Criar)</button>
                <button class="role-btn btn-red" onclick="joinGame('red')"><i class="fa-solid fa-gamepad"></i> VERMELHO</button>
                <button class="role-btn btn-green" onclick="joinGame('green')"><i class="fa-solid fa-gamepad"></i> VERDE</button>
            </div>
        </div>
    </div>

    <div id="screen-judge" class="screen">
        <div class="judge-header">
            <div style="font-weight:bold; color:var(--accent)"><i class="fa-solid fa-wifi"></i> <span id="roomDisplay"></span></div>
            <div class="switch-container">
                <i class="fa-solid fa-trophy"></i> Placar
                <label class="switch"><input type="checkbox" id="scoreToggle" onchange="game.toggleScore()"><span class="slider"></span></label>
            </div>
        </div>

        <div id="scoreHeaderJ" class="scoreboard" style="display:none;">
            <div class="score-box sc-red"><i class="fa-solid fa-square"></i> <span id="sJ-red">0</span></div>
            <div class="score-box sc-green"><i class="fa-solid fa-square"></i> <span id="sJ-green">0</span></div>
        </div>

        <div class="judge-content">
            <div id="buzzerStatus" class="buzzer-status">AGUARDANDO...</div>
            <div id="judgeTimer" class="timer-display"></div>

            <div class="question-card">
                <div class="q-meta">
                    <span id="qDiffDisplay">Média</span>
                    <span id="qPointsDisplay">2 pts</span>
                </div>
                <div id="qText" class="q-text">Selecione uma dificuldade...</div>
                <div id="qOptions"></div>
            </div>
        </div>

        <div class="controls-area">
            <div style="font-size:0.7rem; color:#aaa; margin-bottom:5px;">PRÓXIMA PERGUNTA:</div>
            <div class="btn-grid">
                <button class="action-btn btn-easy" onclick="game.nextQuestion('Fácil')">FÁCIL</button>
                <button class="action-btn btn-med" onclick="game.nextQuestion('Média')">MÉDIA</button>
                <button class="action-btn btn-hard" onclick="game.nextQuestion('Difícil')">DIFÍCIL</button>
                <button class="action-btn btn-rand" onclick="game.nextQuestion('Random')"><i class="fa-solid fa-shuffle"></i></button>
            </div>

            <div class="btn-grid-actions">
                <button id="btnShowMobile" class="action-btn" style="background:var(--primary); grid-column:span 2" onclick="game.sendToPlayer()">
                    <i class="fa-solid fa-mobile-screen"></i> MOSTRAR NO CELULAR
                </button>
                
                <button id="btnRight" class="action-btn" style="background:var(--green-btn)" onclick="game.judgeAnswer(true)" disabled>
                    <i class="fa-solid fa-check"></i> CERTO
                </button>
                <button id="btnWrong" class="action-btn" style="background:var(--red-btn)" onclick="game.judgeAnswer(false)" disabled>
                    <i class="fa-solid fa-xmark"></i> ERRADO
                </button>
                
                <button class="action-btn" style="background:#444" onclick="game.anulateRound()">
                    <i class="fa-solid fa-ban"></i> ANULAR
                </button>
                
                <button id="btnPassTurn" class="action-btn" style="background:#e67e22; display:none;" onclick="game.passTurn()">
                    <i class="fa-solid fa-share"></i> PASSAR VEZ
                </button>
            </div>
        </div>
    </div>

    <div id="screen-player" class="screen">
        <div id="scoreHeaderP" class="scoreboard" style="display:none;">
            <div class="score-box sc-red"><i class="fa-solid fa-square"></i> <span id="sP-red">0</span></div>
            <div class="score-box sc-green"><i class="fa-solid fa-square"></i> <span id="sP-green">0</span></div>
        </div>

        <div class="player-content">
            <h2 id="pRoleTitle" style="margin-bottom:10px;">JOGADOR</h2>
            <div id="pTimer" class="timer-display"></div>
            
            <button id="mainButton" class="big-button" onmousedown="player.buzz()" ontouchstart="player.buzz()">
                <i class="fa-regular fa-hand-point-up"></i>
                APERTE
            </button>
            <div id="pMsg" style="margin-top:20px; color:#aaa; font-weight:bold; font-size:1.2rem; text-align:center; padding:0 20px;">Aguardando...</div>

            <div id="interactionModal" class="player-q-modal">
                <h3 style="text-align:center; margin-bottom:20px;">Responda:</h3>
                <div id="pQuestionText" style="font-size:1.1rem; margin-bottom:20px;">...</div>
                <div id="pOptionsArea" style="flex:1; overflow-y:auto;"></div>
                <button onclick="player.confirmAnswer()" style="margin-top:10px; padding:20px; background:var(--green-btn); border:none; border-radius:10px; font-weight:bold; width:100%; color:#000; font-size:1.2rem;">CONFIRMAR RESPOSTA</button>
            </div>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS (1000+ Perguntas seriam aqui) ---
        const DB = [
            { t: "Qual é a capital do Brasil?", o: ["Rio de Janeiro", "Brasília", "São Paulo", "Salvador"], a: 1, d: "Fácil" },
            { t: "Quantos estados tem o Brasil?", o: ["26 + DF", "25", "27", "28"], a: 0, d: "Fácil" },
            { t: "Quem escreveu Dom Casmurro?", o: ["Jorge Amado", "Machado de Assis", "Alencar", "Verissimo"], a: 1, d: "Média" },
            { t: "Elemento químico 'Fe'?", o: ["Ferro", "Flúor", "Fósforo", "Frâncio"], a: 0, d: "Fácil" },
            { t: "Em que ano ocorreu a Revolução Francesa?", o: ["1789", "1800", "1500", "1990"], a: 0, d: "Difícil" },
            { t: "Qual o maior osso do corpo humano?", o: ["Fêmur", "Tíbia", "Úmero", "Rádio"], a: 0, d: "Média" },
            { t: "Planeta mais próximo do Sol?", o: ["Vênus", "Terra", "Mercúrio", "Marte"], a: 2, d: "Média" }
        ];

        // --- SISTEMA ---
        const peerPrefix = "quiz-pro-final-v9-";
        let peer, conn, myRole;
        let connections = [];
        let timerInt;
        
        let state = {
            scoreMode: false,
            scores: { red: 0, green: 0 },
            currentQ: null,
            locked: false,
            turn: null, // 'red' | 'green'
            phase: 'idle' // 'idle', 'buzzed', 'passed'
        };

        // --- CONEXÃO ---
        function joinGame(role) {
            const room = document.getElementById('roomName').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const name = document.getElementById('playerName').value.trim();
            if(!room || !name) return alert("Preencha Sala e Nome!");

            myRole = role;
            document.getElementById('loading').style.display = 'flex';

            if(role === 'judge') {
                peer = new Peer(peerPrefix + room);
                peer.on('open', () => initGame(room));
                peer.on('error', () => { alert("Sala ocupada!"); location.reload(); });
                peer.on('connection', c => {
                    connections.push(c);
                    c.on('data', d => handleData(d, c));
                    c.on('close', () => connections = connections.filter(x => x!==c));
                    c.send({ type: 'sync', scoreMode: state.scoreMode, scores: state.scores });
                });
            } else {
                peer = new Peer();
                peer.on('open', () => {
                    conn = peer.connect(peerPrefix + room, { metadata: { role, name } });
                    conn.on('open', () => initGame(room));
                    conn.on('data', d => handleData(d));
                    conn.on('error', () => { alert("Juiz não encontrado!"); location.reload(); });
                });
            }
        }

        function initGame(room) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('screen-lobby').classList.remove('active');
            
            if(myRole === 'judge') {
                document.getElementById('screen-judge').classList.add('active');
                document.getElementById('roomDisplay').innerText = room;
                game.nextQuestion('Random');
            } else {
                document.getElementById('screen-player').classList.add('active');
                const t = document.getElementById('pRoleTitle');
                const b = document.getElementById('mainButton');
                if(myRole === 'red') { t.innerText = "VERMELHO"; t.style.color = "var(--red-btn)"; b.classList.add('btn-bg-red'); }
                else { t.innerText = "VERDE"; t.style.color = "var(--green-btn)"; b.classList.add('btn-bg-green'); }
            }
        }

        // --- LÓGICA DO JUIZ ---
        const game = {
            toggleScore: function() {
                state.scoreMode = document.getElementById('scoreToggle').checked;
                const disp = state.scoreMode ? 'flex' : 'none';
                document.getElementById('scoreHeaderJ').style.display = disp;
                broadcast({ type: 'toggleScore', mode: state.scoreMode });
            },

            nextQuestion: function(diff) {
                state.phase = 'idle'; state.turn = null; state.locked = false;
                clearInterval(timerInt);
                
                let pool = (diff === 'Random') ? DB : DB.filter(q => q.d === diff);
                if(pool.length === 0) pool = DB;
                state.currentQ = pool[Math.floor(Math.random() * pool.length)];

                // UI
                document.getElementById('qDiffDisplay').innerText = state.currentQ.d;
                const pts = state.currentQ.d === 'Fácil' ? 1 : (state.currentQ.d === 'Média' ? 2 : 3);
                document.getElementById('qPointsDisplay').innerText = pts + " PONTO(S)";
                document.getElementById('qText').innerText = state.currentQ.t;
                
                const optsDiv = document.getElementById('qOptions');
                optsDiv.innerHTML = '';
                state.currentQ.o.forEach((opt, i) => {
                    optsDiv.innerHTML += `<div class="answer-option" id="j-opt-${i}"><span>${opt}</span> ${i === state.currentQ.a ? '<i class="fa-solid fa-star" style="color:var(--gold)"></i>' : ''}</div>`;
                });

                document.getElementById('buzzerStatus').innerText = "BOTÕES LIBERADOS";
                document.getElementById('buzzerStatus').style.color = "#fff";
                document.getElementById('judgeTimer').innerText = "";
                
                // Botões de controle da rodada
                document.getElementById('btnRight').disabled = true;
                document.getElementById('btnWrong').disabled = true;
                document.getElementById('btnPassTurn').style.display = 'none';

                broadcast({ type: 'unlock' });
            },

            handleBuzz: function(role, name) {
                if(state.locked) return;
                state.locked = true;
                state.turn = role;
                state.phase = 'buzzed';

                document.getElementById('buzzerStatus').innerHTML = `<span style="color:var(--${role}-btn)">${name} APERTOU!</span>`;
                
                // Habilita controles manuais do juiz
                document.getElementById('btnRight').disabled = false;
                document.getElementById('btnWrong').disabled = false;

                game.startTimer(15);
                broadcast({ type: 'lock', winner: role });
            },

            startTimer: function(sec) {
                clearInterval(timerInt);
                let t = sec;
                const display = (v) => {
                    document.getElementById('judgeTimer').innerText = v;
                    broadcast({ type: 'timer', val: v });
                };
                display(t);
                timerInt = setInterval(() => {
                    t--;
                    display(t);
                    if(t <= 0) {
                        clearInterval(timerInt);
                        document.getElementById('judgeTimer').innerText = "TEMPO!";
                        
                        // Se for a primeira vez e acabar o tempo -> Habilita passar vez
                        if(state.phase === 'buzzed') {
                            document.getElementById('btnPassTurn').style.display = 'inline-block';
                            document.getElementById('btnRight').disabled = true;
                            document.getElementById('btnWrong').disabled = true;
                            document.getElementById('buzzerStatus').innerText = "TEMPO ESGOTADO. PASSAR VEZ?";
                        } else {
                            // Se for repescagem -> Fim de papo
                            game.anulateRound();
                        }
                    }
                }, 1000);
            },

            judgeAnswer: function(isCorrect) {
                clearInterval(timerInt);
                const pts = state.currentQ.d === 'Fácil' ? 1 : (state.currentQ.d === 'Média' ? 2 : 3);
                
                // Se acertou
                if(isCorrect) {
                    if(state.scoreMode) {
                        state.scores[state.turn] += pts;
                        game.updateScores();
                    }
                    broadcast({ type: 'result', correct: true });
                    document.getElementById('buzzerStatus').innerText = "RESPOSTA CERTA!";
                    // Bloqueia botões pois acabou a rodada
                    document.getElementById('btnRight').disabled = true;
                    document.getElementById('btnWrong').disabled = true;
                    document.getElementById('btnPassTurn').style.display = 'none';
                } 
                // Se errou
                else {
                    if(state.scoreMode) {
                        // Se for primeira tentativa, perde pontos
                        if(state.phase === 'buzzed') {
                            state.scores[state.turn] -= pts;
                            game.updateScores();
                        }
                    }
                    
                    broadcast({ type: 'result', correct: false, msg: "ERROU!" });
                    
                    if(state.phase === 'buzzed') {
                        document.getElementById('buzzerStatus').innerText = "ERROU! PASSAR A VEZ?";
                        document.getElementById('btnPassTurn').style.display = 'inline-block';
                        // Desabilita certo/errado até passar a vez
                        document.getElementById('btnRight').disabled = true;
                        document.getElementById('btnWrong').disabled = true;
                    } else {
                        document.getElementById('buzzerStatus').innerText = "NINGUÉM PONTUOU.";
                    }
                }
            },

            passTurn: function() {
                const otherRole = state.turn === 'red' ? 'green' : 'red';
                state.turn = otherRole;
                state.phase = 'passed';
                
                document.getElementById('buzzerStatus').innerHTML = `VEZ DE: <span style="color:var(--${otherRole}-btn)">${otherRole.toUpperCase()}</span>`;
                document.getElementById('btnPassTurn').style.display = 'none'; 
                
                // Habilita controles para o novo jogador
                document.getElementById('btnRight').disabled = false;
                document.getElementById('btnWrong').disabled = false;

                // Reinicia timer para o segundo jogador (10s)
                game.startTimer(10); 
                
                broadcast({ type: 'pass-turn', to: otherRole });
            },

            anulateRound: function() {
                clearInterval(timerInt);
                broadcast({ type: 'info', msg: "RODADA ANULADA" });
                document.getElementById('buzzerStatus').innerText = "ANULADA. AGUARDE...";
                setTimeout(() => game.nextQuestion('Random'), 2000);
            },

            sendToPlayer: function() {
                // Envia para o jogador da vez (se estiver bloqueado)
                if(!state.locked || !state.turn) return alert("Espere alguém apertar o botão!");
                
                const targetConn = connections.find(c => c.metadata.role === state.turn);
                if(targetConn) {
                    targetConn.send({ 
                        type: 'interaction', 
                        q: state.currentQ.t, 
                        o: state.currentQ.o 
                    });
                    document.getElementById('buzzerStatus').innerText = "ENVIADO PARA CELULAR...";
                }
            },

            receivePlayerChoice: function(idx) {
                // AUTO-VALIDAÇÃO DO SISTEMA
                const isCorrect = (idx === state.currentQ.a);
                
                // Feedback visual no juiz
                document.querySelectorAll('.answer-option').forEach(el => el.classList.remove('selected'));
                const el = document.getElementById(`j-opt-${idx}`);
                if(el) el.classList.add('selected');

                // Chama a função de julgamento automaticamente
                game.judgeAnswer(isCorrect);
            },

            updateScores: function() {
                document.getElementById('sJ-red').innerText = state.scores.red;
                document.getElementById('sJ-green').innerText = state.scores.green;
                broadcast({ type: 'score-update', scores: state.scores });
            }
        };

        // --- MENSAGENS E EVENTOS ---
        function handleData(d, connRef) {
            // JUIZ RECEBE
            if(myRole === 'judge') {
                if(d.type === 'buzz') game.handleBuzz(d.role, connRef.metadata.name);
                if(d.type === 'answer') game.receivePlayerChoice(d.idx);
            } 
            // JOGADOR RECEBE
            else {
                const btn = document.getElementById('mainButton');
                const msg = document.getElementById('pMsg');
                const timer = document.getElementById('pTimer');

                if(d.type === 'sync' || d.type === 'toggleScore') {
                    document.getElementById('scoreHeaderP').style.display = d.scoreMode ? 'flex' : 'none';
                    if(d.scores) {
                        document.getElementById('sP-red').innerText = d.scores.red;
                        document.getElementById('sP-green').innerText = d.scores.green;
                    }
                }
                if(d.type === 'score-update') {
                    document.getElementById('sP-red').innerText = d.scores.red;
                    document.getElementById('sP-green').innerText = d.scores.green;
                }
                if(d.type === 'unlock') {
                    btn.classList.remove('locked', 'celebrating', 'sad-shake');
                    msg.innerText = "APERTE AGORA!"; msg.style.color = "#fff";
                    timer.innerText = "";
                    document.getElementById('interactionModal').style.display = 'none';
                    player.cleanupConfetti();
                }
                if(d.type === 'lock') {
                    btn.classList.add('locked');
                    if(d.winner === myRole) {
                        btn.classList.add('celebrating');
                        msg.innerText = "SUA VEZ!"; msg.style.color = "var(--gold)";
                        player.confetti();
                        if(navigator.vibrate) navigator.vibrate(200);
                    } else {
                        btn.classList.add('sad-shake');
                        msg.innerText = "BLOQUEADO"; msg.style.color = "#aaa";
                    }
                }
                if(d.type === 'timer') timer.innerText = d.val;
                
                if(d.type === 'interaction') player.showInteraction(d.q, d.o);
                
                if(d.type === 'pass-turn') {
                    if(d.to === myRole) {
                        btn.classList.add('celebrating');
                        btn.classList.remove('locked', 'sad-shake');
                        msg.innerText = "REPESCAGEM: SUA VEZ!"; msg.style.color = "#e67e22";
                        player.confetti();
                        if(navigator.vibrate) navigator.vibrate([100,100,100]);
                    } else {
                        msg.innerText = "VEZ DO OPONENTE"; msg.style.color = "#aaa";
                    }
                }
                if(d.type === 'result') {
                    document.getElementById('interactionModal').style.display = 'none';
                    if(d.correct) {
                        if(btn.classList.contains('celebrating')) {
                            msg.innerText = "VOCÊ ACERTOU!"; msg.style.color = "var(--green-btn)";
                        } else {
                            msg.innerText = "OPONENTE ACERTOU"; msg.style.color = "#aaa";
                        }
                    } else {
                        if(btn.classList.contains('celebrating')) {
                            msg.innerText = "VOCÊ ERROU!"; msg.style.color = "var(--red-btn)";
                            btn.classList.remove('celebrating');
                            btn.classList.add('sad-shake');
                        } else {
                            msg.innerText = "OPONENTE ERROU"; msg.style.color = "#fff";
                        }
                    }
                    timer.innerText = "";
                }
                if(d.type === 'info') { 
                    msg.innerText = d.msg; 
                    player.cleanupConfetti();
                    document.getElementById('interactionModal').style.display = 'none';
                }
            }
        }

        function broadcast(msg) {
            connections.forEach(c => c.send(msg));
        }

        // --- LÓGICA DO JOGADOR ---
        let selectedOption = -1;
        const player = {
            buzz: function() {
                const btn = document.getElementById('mainButton');
                if(btn.classList.contains('locked')) {
                    btn.classList.add('sad-shake');
                    setTimeout(() => btn.classList.remove('sad-shake'), 500);
                    return;
                }
                conn.send({ type: 'buzz', role: myRole });
                if(navigator.vibrate) navigator.vibrate(50);
            },
            
            showInteraction: function(text, options) {
                const modal = document.getElementById('interactionModal');
                const area = document.getElementById('pOptionsArea');
                document.getElementById('pQuestionText').innerText = text;
                area.innerHTML = '';
                selectedOption = -1;
                
                options.forEach((opt, i) => {
                    const b = document.createElement('button');
                    b.className = 'p-opt-btn';
                    b.innerText = opt;
                    b.onclick = () => {
                        document.querySelectorAll('.p-opt-btn').forEach(x => x.classList.remove('selected'));
                        b.classList.add('selected');
                        selectedOption = i;
                    };
                    area.appendChild(b);
                });
                modal.style.display = 'flex';
            },

            confirmAnswer: function() {
                if(selectedOption === -1) return alert("Selecione uma opção!");
                conn.send({ type: 'answer', idx: selectedOption });
                document.getElementById('pMsg').innerText = "Verificando...";
            },

            confetti: function() {
                for(let i=0; i<30; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    c.style.backgroundColor = ['#f00', '#0f0', '#00f', '#ff0'][Math.floor(Math.random()*4)];
                    document.body.appendChild(c);
                }
            },
            cleanupConfetti: function() {
                document.querySelectorAll('.confetti').forEach(e => e.remove());
            }
        };

    </script>
</body>
</html>
