<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Show - Buzzer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #FF6584;
            --accent: #42EADD;
            --bg: #1a1a2e;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-strong: rgba(20, 20, 35, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
            --red-btn: #ff4757;
            --green-btn: #2ed573;
            --gold: #ffd700;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at 10% 20%, rgba(108, 99, 255, 0.2) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(255, 101, 132, 0.2) 0%, transparent 20%);
            color: var(--text);
            height: 100vh; /* Altura fixa para evitar barra de rolagem geral */
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- LAYOUT GERAL --- */
        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            background: var(--bg);
        }
        .screen.active { display: flex; }

        /* --- LOBBY --- */
        .lobby-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        .lobby-box {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h1 { margin-bottom: 20px; font-size: 2rem; background: linear-gradient(90deg, var(--accent), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 10px; color: white; font-size: 1.1rem; text-align: center; }
        .role-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; color: #fff; }
        .btn-judge { background: var(--primary); }
        .btn-red { background: var(--red-btn); }
        .btn-green { background: var(--green-btn); }

        /* --- TELA JUIZ (CSS Grid/Flex para Responsividade) --- */
        /* Header fixo no topo */
        .judge-header {
            flex: 0 0 auto; /* N√£o encolhe nem cresce */
            padding: 10px 15px;
            background: rgba(0,0,0,0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        /* √Årea central com scroll */
        .judge-content {
            flex: 1 1 auto; /* Ocupa o espa√ßo restante */
            overflow-y: auto; /* Scroll se a pergunta for grande */
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Footer fixo embaixo */
        .judge-footer {
            flex: 0 0 auto;
            padding: 10px;
            background: rgba(0,0,0,0.4);
            border-top: 1px solid var(--glass-border);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .buzzer-status {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid transparent;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-card {
            background: var(--glass-strong);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            height: 100%; /* Ocupa altura do pai */
        }
        .q-text { font-size: 1.1rem; margin-bottom: 15px; line-height: 1.4; }
        .answer-option { background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 5px; border-radius: 8px; font-size: 0.9rem; }
        .answer-option.correct { border: 1px solid var(--green-btn); color: var(--green-btn); font-weight: bold; }
        
        .action-btn { padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 0.9rem; color: white; cursor: pointer; }

        /* --- TELA JOGADOR --- */
        .player-screen-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .big-button {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.3);
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2;
        }
        .big-button:active { transform: scale(0.95); }
        .btn-bg-red { background: var(--red-btn); }
        .btn-bg-green { background: var(--green-btn); }
        
        /* Estados do Jogador */
        .big-button.locked { filter: grayscale(100%); cursor: not-allowed; }
        
        /* Anima√ß√£o Vencedor */
        .celebrating { animation: pulseWin 0.8s infinite alternate; border-color: var(--gold); box-shadow: 0 0 50px var(--gold); }
        @keyframes pulseWin { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* Anima√ß√£o Perdedor (Triste) */
        .sad-shake { animation: shake 0.5s; filter: grayscale(100%) !important; opacity: 0.6; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        /* Timer */
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            margin: 10px 0;
            height: 50px; /* reserva espa√ßo */
            display: flex; align-items: center; justify-content: center;
        }

        .notification-area {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            min-height: 1.5em;
            margin-top: 20px;
            color: #ddd;
            z-index: 2;
        }

        /* Confete CSS simplificado */
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 1; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* Modal Loading */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-msg">Conectando...</div>
    </div>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="lobby-box">
                <h1><i class="fa-solid fa-bolt"></i> QUIZ SHOW</h1>
                <p style="margin-bottom: 20px; opacity: 0.7;">Perguntas e Respostas</p>
                <input type="text" id="roomName" placeholder="Nome da Sala (Ex: familia)" autocomplete="off">
                <input type="text" id="playerName" placeholder="Seu Nome" autocomplete="off">
                <div style="margin-top: 20px;">
                    <button class="role-btn btn-judge" onclick="joinGame('judge')"><i class="fa-solid fa-gavel"></i> SOU O JUIZ</button>
                    <button class="role-btn btn-red" onclick="joinGame('red')"><i class="fa-solid fa-hand-point-up"></i> BOT√ÉO VERMELHO</button>
                    <button class="role-btn btn-green" onclick="joinGame('green')"><i class="fa-solid fa-hand-point-up"></i> BOT√ÉO VERDE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-judge" class="screen">
        <div class="judge-header">
            <span><i class="fa-solid fa-wifi"></i> Sala: <b id="displayRoomJudge">...</b></span>
            <span id="judgeConnectionStatus" style="font-size:0.7rem; color:var(--accent);">Aguardando...</span>
        </div>

        <div class="judge-content">
            <div id="buzzerDisplay" class="buzzer-status">BOT√ïES LIBERADOS</div>
            <div id="judgeTimer" class="timer-display" style="font-size: 2rem;"></div>

            <div class="question-card">
                <div id="qDiff" style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase;">DIFICULDADE</div>
                <div id="qText" class="q-text">Carregando pergunta...</div>
                <div id="qOptions"></div>
            </div>
        </div>

        <div class="judge-footer">
            <button class="action-btn" style="background: #444;" onclick="game.resetBuzzers()">
                <i class="fa-solid fa-eraser"></i> Limpar
            </button>
            <button class="action-btn" style="background: var(--primary);" onclick="game.nextQuestion()">
                Pr√≥xima <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="screen-player" class="screen">
        <div class="player-screen-content">
            <div style="position: absolute; top: 20px; text-align: center;">
                <h2 id="playerRoleDisplay">JOGADOR</h2>
                <div style="font-size: 0.8rem; opacity: 0.7;">Sala: <span id="displayRoomPlayer"></span></div>
            </div>

            <div id="playerTimer" class="timer-display"></div>

            <button id="mainButton" class="big-button" onmousedown="playerBuzz()" ontouchstart="playerBuzz()">
                <i class="fa-regular fa-hand-point-up" style="font-size: 3rem; margin-bottom: 10px;"></i>
                APERTE!
            </button>

            <div id="playerNotification" class="notification-area">Aguardando...</div>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS (Exemplo compactado) ---
        const questionsDB = [
            { t: "Capital do Tocantins?", options: ["Palmas", "Bel√©m", "Goi√¢nia", "Macap√°"], a: 0, d: "F√°cil" },
            { t: "Autor de Dom Casmurro?", options: ["Jorge Amado", "Machado de Assis", "Clarice", "Lobato"], a: 1, d: "F√°cil" },
            { t: "Moeda antes do Real?", options: ["Cruzeiro Real", "Cruzado", "Cruzeiro", "Todas"], a: 3, d: "M√©dia" },
            { t: "Planeta vermelho?", options: ["Marte", "J√∫piter", "Saturno", "V√™nus"], a: 0, d: "F√°cil" },
            { t: "Sigla da ONU?", options: ["Org. Na√ß√µes Unidas", "Org. Nacional", "Obras Unidas", "N/A"], a: 0, d: "F√°cil" },
            // ... (Pode adicionar mais perguntas aqui)
        ];
        // Adicionei algumas repetidas para teste r√°pido, na vers√£o final use as 50+
        for(let i=0; i<5; i++) questionsDB.push(...questionsDB); 

        // --- L√ìGICA DE REDE E JOGO ---
        const peerPrefix = "quiz-v3-buzzer-"; 
        let peer = null;
        let conn = null;
        let connections = [];
        let myRole = '';
        let timerInterval = null;
        
        // --- INICIALIZA√á√ÉO ---
        function joinGame(role) {
            const rInput = document.getElementById('roomName').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const pInput = document.getElementById('playerName').value.trim();

            if (!rInput || !pInput) { alert("Preencha todos os campos."); return; }

            myRole = role;
            const myName = pInput;
            document.getElementById('loading-overlay').style.display = 'flex';

            if (role === 'judge') {
                const myPeerId = peerPrefix + rInput;
                peer = new Peer(myPeerId);
                peer.on('open', () => startGameUI(rInput));
                peer.on('error', (err) => { alert("Sala ocupada ou erro de conex√£o."); location.reload(); });
                peer.on('connection', (c) => {
                    connections.push(c);
                    setupJudgeConnection(c);
                    updateJudgeStatus();
                });
            } else {
                peer = new Peer();
                peer.on('open', () => {
                    conn = peer.connect(peerPrefix + rInput, { metadata: { name: myName, role: role } });
                    conn.on('open', () => startGameUI(rInput));
                    conn.on('data', (data) => handlePlayerMessage(data));
                    conn.on('error', () => { alert("Juiz n√£o encontrado."); location.reload(); });
                });
            }
        }

        function startGameUI(room) {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('screen-lobby').classList.remove('active');
            
            if (myRole === 'judge') {
                document.getElementById('screen-judge').classList.add('active');
                document.getElementById('displayRoomJudge').innerText = room;
                game.nextQuestion();
            } else {
                document.getElementById('screen-player').classList.add('active');
                document.getElementById('displayRoomPlayer').innerText = room;
                const btn = document.getElementById('mainButton');
                const title = document.getElementById('playerRoleDisplay');
                if (myRole === 'red') {
                    btn.classList.add('btn-bg-red');
                    title.innerText = "VERMELHO";
                    title.style.color = "var(--red-btn)";
                } else {
                    btn.classList.add('btn-bg-green');
                    title.innerText = "VERDE";
                    title.style.color = "var(--green-btn)";
                }
            }
        }

        // --- JUIZ ---
        function setupJudgeConnection(c) {
            c.on('data', (data) => {
                if (data.type === 'buzz') game.handleBuzz(data.role, c.metadata.name);
            });
            c.on('close', () => { connections = connections.filter(conn => conn !== c); updateJudgeStatus(); });
        }

        function updateJudgeStatus() {
            const red = connections.find(c => c.metadata.role === 'red');
            const green = connections.find(c => c.metadata.role === 'green');
            document.getElementById('judgeConnectionStatus').innerText = 
                (red ? "üî¥ ON " : "üî¥ OFF ") + "|" + (green ? " üü¢ ON" : " üü¢ OFF");
        }

        // --- L√ìGICA DO GAME (JUIZ) ---
        const game = {
            isLocked: false, // Come√ßa desbloqueado (Pedido do usu√°rio)

            handleBuzz: function(role, name) {
                if (this.isLocked) return;
                this.isLocked = true; // Bloqueia agora que algu√©m apertou

                // UI Juiz
                const display = document.getElementById('buzzerDisplay');
                display.innerHTML = `<span style="color:${role === 'red' ? 'var(--red-btn)' : 'var(--green-btn)'}">${name.toUpperCase()} APERTOU!</span>`;
                
                // Inicia Timer
                this.startTimer(10);

                // Avisa Jogadores
                this.broadcast({ type: 'lock', winner: role, winnerName: name });
            },

            startTimer: function(seconds) {
                clearInterval(timerInterval);
                let timeLeft = seconds;
                
                // Fun√ß√£o para atualizar UI do Timer do Juiz
                const updateJudgeTimer = (val) => document.getElementById('judgeTimer').innerText = val > 0 ? val : "";

                updateJudgeTimer(timeLeft);
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateJudgeTimer(timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('judgeTimer').innerText = "TEMPO ESGOTADO!";
                        this.broadcast({ type: 'time-up' });
                    }
                }, 1000);
            },

            resetBuzzers: function() {
                this.isLocked = false;
                clearInterval(timerInterval);
                document.getElementById('judgeTimer').innerText = "";
                document.getElementById('buzzerDisplay').innerText = "BOT√ïES LIBERADOS";
                document.getElementById('buzzerDisplay').style.color = "#fff";
                this.broadcast({ type: 'unlock' });
            },

            nextQuestion: function() {
                // Sorteio
                const q = questionsDB[Math.floor(Math.random() * questionsDB.length)];
                
                // UI
                document.getElementById('qDiff').innerText = "DIFICULDADE: " + q.d;
                document.getElementById('qText').innerText = q.t;
                const optsDiv = document.getElementById('qOptions');
                optsDiv.innerHTML = '';
                q.options.forEach((opt, i) => {
                    const d = document.createElement('div');
                    d.className = 'answer-option ' + (i === q.a ? 'correct' : '');
                    d.innerText = opt;
                    optsDiv.appendChild(d);
                });

                // Libera Bot√µes e limpa timer (Regra 2)
                this.resetBuzzers();
            },

            broadcast: function(msg) {
                connections.forEach(c => c.send(msg));
            }
        };

        // --- L√ìGICA JOGADOR ---
        function playerBuzz() {
            const btn = document.getElementById('mainButton');
            
            // Se estiver bloqueado e tentar apertar: Anima√ß√£o Triste
            if (btn.classList.contains('locked')) {
                btn.classList.add('sad-shake');
                document.getElementById('playerNotification').innerText = "Tarde demais!";
                if(navigator.vibrate) navigator.vibrate(200);
                setTimeout(() => btn.classList.remove('sad-shake'), 500);
                return;
            }

            // Se estiver livre: Envia Buzz
            if (conn) {
                conn.send({ type: 'buzz', role: myRole });
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                c.style.backgroundColor = ['#f00', '#0f0', '#00f', '#ff0'][Math.floor(Math.random()*4)];
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }

        function handlePlayerMessage(data) {
            const btn = document.getElementById('mainButton');
            const notif = document.getElementById('playerNotification');
            const timerEl = document.getElementById('playerTimer');

            if (data.type === 'unlock') {
                // Reseta tudo
                btn.classList.remove('locked', 'celebrating');
                btn.style.opacity = '1';
                notif.innerText = "APERTE AGORA!";
                notif.style.color = "#fff";
                timerEl.innerText = "";
                clearInterval(timerInterval);
                document.querySelectorAll('.confetti').forEach(e => e.remove());
            } 
            else if (data.type === 'lock') {
                btn.classList.add('locked');
                
                // Inicia cronometro local de 10s visual
                let localTime = 10;
                timerEl.innerText = localTime;
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    localTime--;
                    if(localTime >= 0) timerEl.innerText = localTime;
                    else clearInterval(timerInterval);
                }, 1000);

                if (data.winner === myRole) {
                    // EU GANHEI
                    btn.classList.add('celebrating');
                    notif.innerText = "üéâ VOC√ä GANHOU O DIREITO! üéâ";
                    notif.style.color = "var(--gold)";
                    createConfetti();
                    if(navigator.vibrate) navigator.vibrate([100,50,100,50,200]);
                } else {
                    // EU PERDI
                    btn.style.opacity = '0.5';
                    notif.innerText = `O JOGADOR ${data.winner === 'red' ? 'VERMELHO' : 'VERDE'} APERTOU!`;
                    notif.style.color = "#aaa";
                }
            }
            else if (data.type === 'time-up') {
                clearInterval(timerInterval);
                timerEl.innerText = "TEMPO ESGOTADO";
                notif.innerText = "Ningu√©m pontuou?";
                btn.classList.remove('celebrating'); // Para a festa se o tempo acabar
            }
        }
    </script>
</body>
</html>
